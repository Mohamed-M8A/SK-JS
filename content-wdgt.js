const allPostsLimit=60,batchSize=10,interactionsKey="user_interactions";let allPosts=[],orderedFeed=[],displayPointer=0,currentStartIndex=1,displayedPosts=new Set(JSON.parse(sessionStorage.getItem("displayedPosts"))||[]);const productpostsElement=document.getElementById("product-posts"),loadMoreButton=document.getElementById("load-more"),loaderElement=document.getElementById("loader"),categoryLevels={"إلكترونيات":.5,"كوبونات خصم":.5,"مقالات":.5};function getUserInteractions(){return JSON.parse(localStorage.getItem(interactionsKey)||"{}")}function setUserInteractions(t){localStorage.setItem(interactionsKey,JSON.stringify(t))}function recordCategoryInteraction(t){let e=getUserInteractions(),s=(new Date).toISOString();t.forEach((t=>{t&&""!==t.trim()||(t="غير مصنف");const n=categoryLevels.hasOwnProperty(t)?categoryLevels[t]:1;e[t]?(e[t].weight+=n,e[t].lastInteraction=s):e[t]={weight:n,lastInteraction:s}})),setUserInteractions(e)}function cleanOldInteractions(){let t=getUserInteractions();const e=(new Date).getTime();Object.keys(t).forEach((s=>{const n=new Date(t[s].lastInteraction).getTime();e-n>2592e6&&delete t[s]})),setUserInteractions(t)}function getPostCategories(t){return t.category&&t.category.length>0?t.category.map((t=>t.term)):["غير مصنف"]}function getPostUrl(t){return t.link.find((t=>"alternate"===t.rel))?.href}function getPostPrice(t){const e=t.content?.$t||"",s=e.match(/<span class="price-discounted">([^<]+)<\/span>/),n=e.match(/<span class="price-original">([^<]+)<\/span>/);return n&&s?{hasDiscount:!0,discountedPrice:s[1],originalPrice:n[1]}:s?{hasDiscount:!1,discountedPrice:s[1]}:null}function getPostImage(t){const e=(t.content?.$t||"").match(/<img[^>]+src=["']([^"']+)["']/i);return e?e[1]:"https://via.placeholder.com/380x225"}function getExtraProductData(t){const e=t.content?.$t||"",s=e.match(/<span class="rating-value"[^>]*>([^<]+)<\/span>/),n=s?parseFloat(s[1]):null,a=e.match(/<div class="info-box orders-info">[\s\S]*?<span class="value">([^<]+)<\/span>/),o=a?a[1]:null,r=e.match(/<div class="info-box shipping-time">[\s\S]*?<span class="value">([^<]+)<\/span>/);return{rating:n,orders:o,shipping:r?r[1]:null}}function generatePostHTML(t){const e=getPostUrl(t);if(!e)return"";const s=(t.content?.$t||"").match(/<h1[^>]*>([^<]+)<\/h1>/),n=s?s[1]:t.title.$t,a=getPostImage(t),o=getPostPrice(t),r=getExtraProductData(t),i=getPostCategories(t).join(",");let c="",l="",d="";if(o){const t=o.originalPrice?`<span class="original-price">${o.originalPrice} ر.س</span>`:"";if(c=`\n      <div class="price-display">\n        <span class="discounted-price">${o.discountedPrice} ر.س</span>\n        ${t}\n      </div>\n    `,o.originalPrice){const t=parseFloat(o.discountedPrice.replace(/[^\d.]/g,"")),e=parseFloat(o.originalPrice.replace(/[^\d.]/g,""));l=`<div class="discount-badge">خصم ${(e>0?(e-t)/e*100:0).toFixed(0)}%</div>`}}return(r.rating||r.orders||r.shipping)&&(d='<div class="product-meta-details">',r.rating&&(d+=`\n        <div class="meta-item">\n          <span class="meta-star">★</span>\n          <span class="meta-rating">${r.rating}</span>\n        </div>\n      `),r.orders&&(d+=`<div class="meta-item">تم البيع <span class="meta-orders">${r.orders}</span></div>`),r.shipping&&(d+=`<div class="meta-item">شحن في <span class="meta-shipping">${r.shipping}</span> أيام</div>`),d+="</div>"),`\n<div class="post-card" data-categories="${i}" data-product-url="${e}">\n  <a href="${e}" target="_blank" class="image-container">\n    <img class="post-image" src="${a}" alt="${n}" loading="lazy">\n    ${l}\n    <div class="external-cart-button">\n      <svg class="icon" width="18" height="18">\n        <use xlink:href="#i-cart"></use>\n      </svg>\n    </div>\n  </a>\n  <div class="post-content">\n    <a href="${e}" target="_blank">\n      <h3 class="post-title">${n}</h3>\n    </a>\n    ${c}\n    ${d}\n  </div>\n</div>\n  `}function displayBatch(){let t=!0;function e(){const e=[];for(;e.length<batchSize&&displayPointer<orderedFeed.length;){const s=orderedFeed[displayPointer],n=getPostUrl(s);if(getPostCategories(s).includes("مقالات"))displayPointer++;else{if(n&&!displayedPosts.has(n))if(displayedPosts.add(n),t)e.push(s);else{const t={...s,lazy:!0};e.push(t)}displayPointer++}}e.length>0&&(productpostsElement.insertAdjacentHTML("beforeend",e.map((t=>{const e=generatePostHTML(t);return t.lazy?e.replace(/<img([^>]+)src="([^"]+)"/,'<img$1src="https://via.placeholder.com/380x225?text=Loading..." data-src="$2" class="lazy-img"'):e})).join("")),sessionStorage.setItem("displayedPosts",JSON.stringify([...displayedPosts]))),t&&(t=!1),displayPointer>=orderedFeed.length&&(clearInterval(s),lazyLoadImages())}e();const s=setInterval(e,1500)}function lazyLoadImages(){const t=document.querySelectorAll("img.lazy-img[data-src]");let e=0;const s=setInterval((()=>{if(e>=t.length)return void clearInterval(s);const n=t[e];n.src=n.dataset.src,n.removeAttribute("data-src"),e++}),1500)}function computeOrderedFeed(t){t.sort(((t,e)=>new Date(e.published.$t)-new Date(t.published.$t)));const e=getUserInteractions();if(0===Object.keys(e).length)return t;const s=Object.keys(e).sort(((t,s)=>e[s].weight-e[t].weight)).slice(0,3),n=[],a=new Set;s.forEach((e=>{t.filter((t=>getPostCategories(t).includes(e))).forEach((t=>{const e=getPostUrl(t);e&&!a.has(e)&&n.length<18&&(n.push(t),a.add(e))}))}));const o=t.filter((t=>!a.has(getPostUrl(t))));return n.concat(o)}function fetchAllPosts(){loaderElement.style.display="block",loadMoreButton.style.display="none";fetch(`https://souq-alkul.blogspot.com/feeds/posts/default?alt=json&start-index=${currentStartIndex}&max-results=${allPostsLimit}`).then((t=>t.json())).then((t=>{const e=t.feed.entry||[];allPosts=allPosts.concat(e),orderedFeed=computeOrderedFeed(allPosts),displayPointer=0,displayBatch(),currentStartIndex+=allPostsLimit})).catch((t=>console.error("❌ خطأ في جلب المنشورات:",t))).finally((()=>{loadMoreButton.style.display="block"}))}function loadMorePosts(){displayPointer<orderedFeed.length?displayBatch():fetchAllPosts()}setInterval(cleanOldInteractions,6e5),loadMoreButton.addEventListener("click",loadMorePosts),productpostsElement.addEventListener("click",(function(t){const e=t.target.closest(".post-card");if(!e)return;const s=e.getAttribute("data-categories");recordCategoryInteraction(s?s.split(","):["غير مصنف"]);if(t.target.closest(".external-cart-button")){try{const t=e.querySelector(".image-container").getAttribute("href"),s=JSON.parse(localStorage.getItem("cart"))||[];s.some((e=>e.productUrl===t))?alert("المنتج موجود بالفعل في العربة!"):(s.push({productUrl:t}),localStorage.setItem("cart",JSON.stringify(s)),alert("تمت إضافة المنتج إلى العربة بنجاح!"))}catch(t){console.error("خطأ في قراءة رابط المنتج:",t)}t.preventDefault()}})),window.onload=function(){displayedPosts=new Set,sessionStorage.setItem("displayedPosts",JSON.stringify([])),fetchAllPosts()};
