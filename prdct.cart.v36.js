/***********************
 * โ ุฅุดุนุงุฑุงุช Toast ุนุงูุฉ
 ***********************/
function showCartToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = "cart-toast";
  toast.textContent = message;

  toast.style.background = (type === "error") ? "#e74c3c" : "#2ecc71";

  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 100);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}

/***********************
 * โ ุชุฎุฒูู ุงูุนุฑุจุฉ (ูุน ุชูุธูู ุงูุฑูุงุจุท)
 ***********************/
function addToCart(productUrl, clean = false) {
  if (clean) {
    const urlObj = new URL(productUrl);
    urlObj.search = ""; // ุญุฐู ุฃู ุจุงุฑุงููุชุฑุงุช
    productUrl = urlObj.toString();
  }

  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  // ๐ ููุน ุงูุชูุฑุงุฑ
  const exists = cart.some(item => item.productUrl === productUrl);
  if (exists) {
    showCartToast("ุงูููุชุฌ ููุฌูุฏ ุจุงููุนู ูู ุงูุนุฑุจุฉ!", "error");
    return;
  }

  cart.push({ productUrl });
  localStorage.setItem("cart", JSON.stringify(cart));
  showCartToast("โ ุชูุช ุฅุถุงูุฉ ุงูููุชุฌ ุฅูู ุงูุนุฑุจุฉ ุจูุฌุงุญ!", "success");
}

/***********************
 * โ ุฒุฑ ุตูุญุฉ ุงูููุชุฌ ููุท
 ***********************/
function handleAddToCart(event) {
  event.preventDefault();
  event.stopPropagation();

  const cleanUrl = window.location.origin + window.location.pathname; 
  addToCart(cleanUrl, false); // ูุถูู ุงูุฑุงุจุท ุจุฏูู ุจุงุฑุงููุชุฑ ููุงุฆููุง
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".add-to-cart").forEach(btn => {
    btn.replaceWith(btn.cloneNode(true)); // ุฅุฒุงูุฉ ุฃู event handlers ูุฏููุฉ
  });

  document.querySelectorAll(".add-to-cart").forEach(btn => {
    btn.addEventListener("click", handleAddToCart);
  });
});

/***********************
 * โ ุฒุฑ ุงูููุฏุฌุช (ุงูุฑุฆูุณูุฉ) ููุท
 ***********************/
document.addEventListener("click", function (e) {
  const postCard = e.target.closest(".post-card");
  if (!postCard) return;

  const cartButton = e.target.closest(".external-cart-button");
  if (cartButton) {
    const productUrl = postCard.getAttribute("data-product-url");
    addToCart(productUrl, false); // ูุฎุฒู ุงูุฑุงุจุท ููุง ูู
    e.preventDefault();
  }
});

/***********************
 * โ ุฅุดุนุงุฑุงุช Toast ููููุจูู
 ***********************/
function showCouponToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = "cart-toast";
  toast.textContent = message;

  toast.style.background = (type === "error") ? "#e74c3c" : "#2ecc71";

  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 100);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}

/***********************
 * โ ูุณุฎ ุงูููุจูู
 ***********************/
window.copyCoupon = function () {
  const codeEl = document.getElementById("couponCode");
  const code = codeEl ? codeEl.innerText.trim() : "";

  if (!code) {
    showCouponToast("ูุง ููุฌุฏ ููุจูู ูููุณุฎ!", "error");
    return;
  }

  navigator.clipboard.writeText(code)
    .then(() => {
      showCouponToast("โ ุชู ูุณุฎ ุงูููุจูู: " + code, "success");
    })
    .catch(() => {
      showCouponToast("ูุดู ูุณุฎ ุงูููุจูู!", "error");
    });
};
