const searchPageURL="https://souq-alkul.blogspot.com/p/search.html";const input=document.getElementById("searchInput");const form=document.querySelector(".search-box-form");const historyDropdown=document.getElementById("searchHistoryDropdown");let searches=JSON.parse(localStorage.getItem('searches'))||[];function updateDropdown(){historyDropdown.innerHTML='';let toShow=searches.slice(0,5);if(toShow.length===0){historyDropdown.style.display='none';return}
toShow.forEach(term=>{let item=document.createElement('div');let text=document.createElement('span');text.textContent=term;text.addEventListener('click',()=>{input.value=term;historyDropdown.style.display='none'});let del=document.createElement('span');del.textContent='×';del.classList.add('delete-btn');del.addEventListener('click',(e)=>{e.stopPropagation();searches=searches.filter(t=>t!==term);localStorage.setItem('searches',JSON.stringify(searches));updateDropdown()});item.appendChild(text);item.appendChild(del);historyDropdown.appendChild(item)});historyDropdown.style.display='block'}
function startSearch(){if(!input)return;const query=input.value.trim();if(query){searches=searches.filter(t=>t!==query);searches.unshift(query);if(searches.length>10)searches=searches.slice(0,10);localStorage.setItem('searches',JSON.stringify(searches));window.location.href=`${searchPageURL}?q=${encodeURIComponent(query)}`}}
if(form){form.addEventListener("submit",function(e){e.preventDefault();startSearch()})}
if(input){input.addEventListener('focus',updateDropdown)}
document.addEventListener('click',(e)=>{if(!e.target.closest('.search-container')){historyDropdown.style.display='none'}});if(input){const placeholders=["ماكينة قهوة ديلونجي","سماعات بلوتوث جالكسي بودز","مكنسة روبوت ذكية","شاحن مغناطيسي للآيفون","ستاند لابتوب قابل للطي","مكواة بخار محمولة","عصارة فواكه كهربائية","كاميرا مراقبة واي فاي","ماوس لاسلكي لابتوب","منظف وجه كهربائي","لوح مفاتيح ميكانيكي RGB","فرامة خضار يدوية","ميزان ذكي للحمية","سماعات رأس للألعاب","ساعة ذكية شاومي","ترايبود كاميرا احترافي","كشاف LED قابل للشحن","دفاية كهربائية صغيرة","مروحة USB مكتبية","عطر عربي فاخر","شاحن متنقل باور بانك","شنطة لابتوب ضد الماء","كرسي ألعاب مريح","سماعات نويس كانسل","خلاط يدوي متعدد الاستخدام","مقص مطبخ ستانلس ستيل","مظلة أوتوماتيكية","فلاش ميموري سريع","مقلاة هوائية صحية","كاميرا فورية بولارويد","ميزان مطبخ رقمي","مبخرة منزلية كهربائية","ترموس حافظ للحرارة","زجاجة ماء ذكية","مصباح مكتب LED","مروحة محمولة باليد","شاحن جداري سريع","منظم أسلاك مكتب","صندوق تخزين بلاستيك","سماعة مكالمات بلوتوث","منقي هواء صغير","سخان ماء كهربائي","دفتر ملاحظات ذكي","قفل بصمة ذكي","موزع صابون أوتوماتيكي","منظم درج ملابس","مقعد أرضي مريح","كوب قهوة حراري","لوحة مفاتيح لاسلكية","مفرمة لحوم كهربائية","أداة تقطيع بطاطس","صانعة فشار منزلية","طقم ملاعق قياس","جهاز قياس حرارة رقمي","منبه مكتبي كلاسيكي","طابعة صور ملونة","لابتوب أسوس","جوال شاومي ريدمي","تابلت سامسونج جالكسي","حقيبة ظهر للطلاب","قرص صلب خارجي","كابل شحن تايب سي","ماوس جيمينج","مكواة شعر سيراميك","عصا سيلفي بلوتوث","آلة حاسبة علمية","سماعة رأس سلكية","دفاية زيت كهربائية","طقم مفكات متعدد","مقص أظافر ستانلس","ابحث في سوق الكل"];function getRandomPlaceholder(){const randomIndex=Math.floor(Math.random()*placeholders.length);return placeholders[randomIndex]}
function rotatePlaceholder(){if(placeholders.length>0){input.setAttribute("placeholder",getRandomPlaceholder())}}
rotatePlaceholder();setInterval(rotatePlaceholder,25000)}
function updateCartWidget(){const cart=JSON.parse(localStorage.getItem("cart"))||[];const cartCountElement=document.getElementById("cart-count");if(!cartCountElement)return;cartCountElement.textContent=cart.length;if(cart.length>0){cartCountElement.classList.add("active")}else{cartCountElement.classList.remove("active")}}
updateCartWidget();window.addEventListener("storage",function(event){if(event.key==="cart"){updateCartWidget()}});setInterval(updateCartWidget,1000);const cartWidget=document.getElementById("cart-widget-header");if(cartWidget){cartWidget.addEventListener("click",function(){window.location.href="/p/cart.html"})}
var htmlEl=document.documentElement,darkBtn=document.getElementById("dark-toggler"),iconUse=darkBtn?darkBtn.querySelector("use"):null;function switchIcon(theme){if(!iconUse)return;if(theme==="dark"){iconUse.setAttribute("xlink:href","#i-sun");iconUse.setAttribute("href","#i-sun")}else{iconUse.setAttribute("xlink:href","#i-moon");iconUse.setAttribute("href","#i-moon")}}
function applyTheme(theme,persist){if(theme==="dark"){htmlEl.classList.add("dark-mode");htmlEl.setAttribute("data-theme","dark")}else{htmlEl.classList.remove("dark-mode");htmlEl.setAttribute("data-theme","light")}
switchIcon(theme);if(persist){try{localStorage.setItem("theme",theme)}catch(e){}}}
var savedTheme;try{savedTheme=localStorage.getItem("theme")}catch(e){savedTheme=null}
if(!savedTheme){savedTheme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}
applyTheme(savedTheme,!1);if(darkBtn){darkBtn.addEventListener("click",function(e){e.preventDefault();var isDark=htmlEl.classList.contains("dark-mode");applyTheme(isDark?"light":"dark",!0)})}
const dropdown=document.getElementById("countryDropdown");const selected=dropdown?dropdown.querySelector(".selected"):null;const options=dropdown?dropdown.querySelector(".options"):null;let toast=document.getElementById("country-toast");if(!toast){toast=document.createElement("div");toast.id="country-toast";document.body.appendChild(toast)}
const url=new URL(window.location.href);const paramCountry=url.searchParams.get("country");const savedCountry=localStorage.getItem("Cntry");let activeCountry=null;function setActiveCountry(code,updateUrl=!0){if(!options)return;const li=options.querySelector(`li[data-value="${code}"]`);if(!li)return;activeCountry=code;localStorage.setItem("Cntry",code);if(selected)selected.innerHTML=li.innerHTML;if(updateUrl){url.searchParams.set("country",code);window.history.replaceState({},"",url)}}
if(paramCountry){setActiveCountry(paramCountry)}else if(savedCountry){setActiveCountry(savedCountry)}else{setActiveCountry("SA")}
if(selected&&dropdown&&options){selected.addEventListener("click",()=>{dropdown.classList.toggle("open");options.style.display=dropdown.classList.contains("open")?"block":"none"});options.addEventListener("click",(e)=>{const li=e.target.closest("li");if(!li)return;const countryCode=li.getAttribute("data-value");setActiveCountry(countryCode);showToast("تم اختيار: "+li.textContent.trim());setTimeout(()=>{window.location.reload()},500)});document.addEventListener("click",(e)=>{if(!dropdown.contains(e.target)){dropdown.classList.remove("open");options.style.display="none"}})}
function showToast(msg){if(!toast)return;toast.textContent=msg;toast.classList.add("show");setTimeout(()=>{toast.classList.remove("show")},1000)}
const canonical=document.createElement("link");canonical.rel="canonical";canonical.href=window.location.origin+window.location.pathname;document.head.appendChild(canonical);if(paramCountry){const robots=document.createElement("meta");robots.name="robots";robots.content="noindex";document.head.appendChild(robots)}
var backTop=document.getElementById("back-to-top");window.addEventListener("scroll",function(){if(!backTop)return;if(this.pageYOffset>=1000){backTop.classList.remove("d-none")}else{backTop.classList.add("d-none")}},!1);function rmurl(e,t){var r=new RegExp(/\?m=0|&m=0|\?m=1|&m=1/g);if(r.test(e)){e=e.replace(r,"");if(t)window.history.replaceState({},document.title,e)}
return e}
const currentUrl=rmurl(location.toString(),!0);const bannedCategories=["مقالات","إعلانات"];function getCurrencySymbol(){const countrySymbols={SA:"ر.س",AE:"د.إ",OM:"ر.ع",MA:"د.م",DZ:"د.ج",TN:"د.ت"};const country=localStorage.getItem("Cntry")||"SA";return countrySymbols[country]||"ر.س"}
function getPostCategories(post){return(post.category&&post.category.length>0)?post.category.map(catObj=>catObj.term):["غير مصنف"]}
function getPostUrl(post){return post.link.find(link=>link.rel==="alternate")?.href}
function getPostTitle(post){const content=post.content?.$t||"";const titleMatch=content.match(/<h2[^>]*class=["']product-title["'][^>]*>([^<]+)<\/h2>/);return titleMatch?titleMatch[1]:post.title?.$t||"بدون عنوان"}
function getPostPrice(post){const content=post.content?.$t||"";const jsonMatch=content.match(/<script[^>]+id=["']product-data["'][^>]*>([\s\S]*?)<\/script>/);if(!jsonMatch)return null;try{const data=JSON.parse(jsonMatch[1]);const country=localStorage.getItem("Cntry")||"SA";const countryData=data.countries?.[country];if(!countryData)return null;const discounted=parseFloat(countryData["price-discounted"]);const original=parseFloat(countryData["price-original"]);return{hasDiscount:!!(original&&discounted<original),discountedPrice:discounted,originalPrice:original,shippingMin:+countryData["shipping-min-days"]||0,shippingMax:+countryData["shipping-max-days"]||0}}catch(err){console.warn("⚠️ خطأ في قراءة JSON داخل المنتج:",err);return null}}
function getExtraProductData(post){const content=post.content?.$t||"";const ratingMatch=content.match(/<span class="rating-value"[^>]*>([^<]+)<\/span>/);const rating=ratingMatch?parseFloat(ratingMatch[1]):null;const ordersMatch=content.match(/<div class="info-box orders-info">[\s\S]*?<span class="value">([^<]+)<\/span>/);const orders=ordersMatch?ordersMatch[1]:null;const priceData=getPostPrice(post);const shipping=priceData&&(priceData.shippingMin||priceData.shippingMax)?`${priceData.shippingMax}-${priceData.shippingMin}`:null;return{rating,orders,shipping}}
function getPostImage(post,size=320){const defaultImage=`https://via.placeholder.com/${size}x${size}/ffffff/ffffff.png`;const content=post.content?.$t||"";const imgMatch=content.match(/<img[^>]+src=["']([^"']+)["']/i);if(!imgMatch)return defaultImage;let imgUrl=imgMatch[1];if(/blogger\.googleusercontent\.com/.test(imgUrl)){if(/\/s\d+/.test(imgUrl)){imgUrl=imgUrl.replace(/\/s\d+/,`/s${size}`)}else if(/\/w\d+-h\d+/.test(imgUrl)){imgUrl=imgUrl.replace(/\/w\d+-h\d+/,`/w${size}-h${size}`)}else{imgUrl=imgUrl.replace(/\/([^/]+)$/,`/s${size}/$1`)}}
return imgUrl}
function generatePostHTML(post,lazy=!1){const url=getPostUrl(post);if(!url)return"";if(getPostCategories(post).some(cat=>bannedCategories.includes(cat))){return""}
const title=getPostTitle(post);const image=getPostImage(post);const priceData=getPostPrice(post);const extraData=getExtraProductData(post);const categories=getPostCategories(post).join(",");const currency=getCurrencySymbol();let priceHtml="";let discountBadge="";if(priceData){const originalPrice=priceData.originalPrice?`<span class="original-price">${priceData.originalPrice.toFixed(2)} ${currency}</span>`:"";priceHtml=`
      <div class="price-display">
        <span class="discounted-price">${priceData.discountedPrice.toFixed(2)} ${currency}</span>
        ${originalPrice}
      </div>
    `;if(priceData.originalPrice&&priceData.discountedPrice<priceData.originalPrice){const discountedValue=priceData.discountedPrice;const originalValue=priceData.originalPrice;const discountPercentage=((originalValue-discountedValue)/originalValue)*100;discountBadge=`<div class="discount-badge">خصم ${discountPercentage.toFixed(0)}%</div>`}}
let extraHtml="";if(extraData.rating||extraData.orders||extraData.shipping){extraHtml=`<div class="product-meta-details">`;if(extraData.rating){extraHtml+=`
        <div class="meta-item">
          <span class="meta-star">★</span>
          <span class="meta-rating">${extraData.rating}</span>
        </div>
      `}
if(extraData.orders){extraHtml+=`<div class="meta-item">تم البيع <span class="meta-orders">${extraData.orders}</span></div>`}
if(extraData.shipping){extraHtml+=`<div class="meta-item">شحن خلال <span class="meta-shipping">${extraData.shipping}</span> أيام</div>`}
extraHtml+=`</div>`}
const imgTag=lazy?`<img class="post-image lazy-img" src="https://via.placeholder.com/320x320/ffffff/ffffff.png" data-src="${image}" alt="${title}" width="320" height="320" loading="lazy">`:`<img class="post-image" src="${image}" alt="${title}" width="320" height="320" loading="lazy">`;return `
    <div class="post-card" data-categories="${categories}" data-product-url="${url}">
      <a href="${url}" target="_blank" class="post-link">
        <div class="image-container">
          ${imgTag}
          ${discountBadge}
          <div class="external-cart-button">
            <svg class="icon" width="18" height="18">
              <use xlink:href="#i-cart"></use>
            </svg>
          </div>
        </div>
        <div class="post-content">
          <h3 class="post-title">${title}</h3>
          ${priceHtml}
          ${extraHtml}
        </div>
      </a>
    </div>
  `}
function lazyLoadImages(){const lazyImages=document.querySelectorAll("img.lazy-img[data-src]");const observer=new IntersectionObserver((entries,obs)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.removeAttribute("data-src");img.classList.remove("lazy-img");obs.unobserve(img)}})},{rootMargin:"100px"});lazyImages.forEach(img=>observer.observe(img))}
let allPosts=[];let productFeed=[];let displayedPosts=new Set();let displayPointer=0;let currentStartIndex=1;const allPostsLimit=50;const batchSize=10;const productpostsElement=document.getElementById("product-posts");const loadMoreButton=document.getElementById("load-more");const loaderElement=document.getElementById("loader");function computeProductFeed(posts){return posts.sort((a,b)=>new Date(b.published.$t)-new Date(a.published.$t))}
function fetchAllPosts(){loaderElement.style.display="block";loadMoreButton.style.display="none";const cached=sessionStorage.getItem("cachedPosts");if(cached){const parsed=JSON.parse(cached);allPosts=parsed;productFeed=computeProductFeed(allPosts);displayPointer=0;displayBatch();loaderElement.style.display="none";return}
const url=`https://souq-alkul.blogspot.com/feeds/posts/default?alt=json&start-index=${currentStartIndex}&max-results=${allPostsLimit}`;fetch(url).then(response=>response.json()).then(data=>{const posts=data.feed.entry||[];allPosts=allPosts.concat(posts);sessionStorage.setItem("cachedPosts",JSON.stringify(allPosts));productFeed=computeProductFeed(allPosts);displayPointer=0;displayBatch();currentStartIndex+=allPostsLimit}).finally(()=>{loaderElement.style.display="none"})}
function displayBatch(){const batch=[];let count=0;while(count<batchSize&&displayPointer<productFeed.length){const post=productFeed[displayPointer];const url=getPostUrl(post);if(getPostCategories(post).some(cat=>bannedCategories.includes(cat))){displayPointer++;continue}
if(url&&!displayedPosts.has(url)){displayedPosts.add(url);batch.push(generatePostHTML(post,displayPointer>=batchSize));count++}
displayPointer++}
if(batch.length>0){productpostsElement.insertAdjacentHTML("beforeend",batch.join(""));sessionStorage.setItem("displayedPosts",JSON.stringify([...displayedPosts]));lazyLoadImages()}}
function loadMorePosts(){fetchAllPosts()}
if(loadMoreButton){loadMoreButton.addEventListener("click",loadMorePosts)}
window.addEventListener("scroll",function(){if((window.innerHeight+window.scrollY)>=document.body.offsetHeight-300){if(displayPointer<productFeed.length){displayBatch()}else{if(loadMoreButton)loadMoreButton.style.display="block"}}});window.onload=function(){displayedPosts=new Set();sessionStorage.setItem("displayedPosts",JSON.stringify([]));fetchAllPosts()};document.addEventListener('DOMContentLoaded',()=>{const categories=[{name:'إلكترونيات',children:[{name:'جوالات',children:[{name:'شاومي'},{name:'سامسونج'},{name:'آيفون'},{name:'أوبو'},{name:'هواوي'}]},{name:'لابتوبات',children:[{name:'جيمينج'},{name:'ماك بوك'},{name:'لابتوبات أعمال'}]},{name:'شاشات',children:[{name:'شاشات ذكية'},{name:'شاشات كمبيوتر'}]}]},{name:'أدوات منزلية',children:[{name:'المطبخ',children:[{name:'خلاطات'},{name:'مكاوي'},{name:'ماكينات قهوة'},{name:'أفران كهربائية'}]},{name:'التنظيف',children:[{name:'مكانس كهربائية'},{name:'غسالات'}]}]},{name:'ملحقات',children:[{name:'سماعات'},{name:'كيبورد وماوس'},{name:'باور بانك'}]},{name:'ألعاب',children:[{name:'بلاي ستيشن'},{name:'إكس بوكس'},{name:'نينتندو سويتش'}]},{name:'عروض خاصة'},{name:'الموضة'},{name:'المنزل والمطبخ'},{name:'أجهزة صغيرة'},{name:'الصحة والجمال'}];function generateLink(cat){const base="https://souq-alkul.blogspot.com/p/search.html";return `${base}?label=${encodeURIComponent(cat.name)}`}
const toggleBtn=document.getElementById('widget-toggle-btn');const closeBtn=document.getElementById('widget-close-btn');const sidebar=document.getElementById('widget-sidebar');const overlay=document.getElementById('widget-overlay');const sideList=document.getElementById('widget-side-list');const desktopCats=document.getElementById('widget-desktop-cats');const sidebarTitle=document.getElementById('widget-sidebar-title');categories.slice(0,5).forEach(cat=>{const wrapper=document.createElement('div');wrapper.className='widget-cat-wrapper';const link=document.createElement('a');link.textContent=cat.name;link.href=generateLink(cat);link.className='widget-cat-link';link.addEventListener('mouseover',()=>link.style.setProperty("--underline-scale","1"));link.addEventListener('mouseout',()=>link.style.setProperty("--underline-scale","0"));wrapper.appendChild(link);if(cat.children){const expandBtn=document.createElement('span');expandBtn.textContent='❯';expandBtn.className='widget-expand-btn';expandBtn.addEventListener('click',(e)=>{e.preventDefault();openSidebar(!1);renderSubCategories(cat.name,cat.children||[])});wrapper.appendChild(expandBtn)}
desktopCats.appendChild(wrapper)});function createCategoryRow(cat){const row=document.createElement('div');row.className='widget-category-row';const link=document.createElement('a');link.textContent=cat.name;link.href=generateLink(cat);row.appendChild(link);if(cat.children){const expandBtn=document.createElement('span');expandBtn.textContent='❯';expandBtn.className='widget-expand-btn-sidebar';expandBtn.addEventListener('click',(e)=>{e.preventDefault();renderSubCategories(cat.name,cat.children)});row.appendChild(expandBtn)}
return row}
function renderMainCategories(){sideList.innerHTML="";sidebarTitle.textContent='التصنيفات';categories.forEach(cat=>sideList.appendChild(createCategoryRow(cat)))}
function renderSubCategories(title,children){sideList.innerHTML="";sidebarTitle.textContent=title;const backRow=document.createElement('div');backRow.textContent='← رجوع';backRow.className='widget-back-row';backRow.addEventListener('click',()=>renderMainCategories());sideList.appendChild(backRow);children.forEach(sub=>sideList.appendChild(createCategoryRow(sub)))}
function openSidebar(showMain=!0){sidebar.style.right='0';overlay.style.display='block';if(showMain)renderMainCategories();}
function closeSidebar(){sidebar.style.right='-300px';overlay.style.display='none'}
toggleBtn.addEventListener('click',()=>openSidebar(!0));closeBtn.addEventListener('click',closeSidebar);overlay.addEventListener('click',closeSidebar);function applyResponsive(){if(window.innerWidth>768){desktopCats.style.display='flex'}}
applyResponsive();window.addEventListener('resize',applyResponsive)});async function searchAndFilterResults(){const container=document.getElementById("search-posts");const loader=document.getElementById("loader");loader.style.display="block";container.innerHTML="";try{const params=new URLSearchParams(window.location.search);const query=params.get("q");const label=params.get("label");const min=parseFloat(params.get("min"))||0;const max=parseFloat(params.get("max"))||Infinity;const discount=parseFloat(params.get("discount"))||0;let entries=await fetchPosts({query,label});entries=filterByPriceAndDiscount(entries,{min,max,discount});loader.style.display="none";if(!entries.length){container.innerHTML="<p>لم يتم العثور على نتائج مطابقة</p>";return}
container.innerHTML=entries.map(p=>generatePostHTML(p,!0)).join("");if(typeof lazyLoadImages==="function")lazyLoadImages();}catch(err){console.error(err);container.innerHTML="<p>حدث خطأ أثناء التحميل</p>"}}
